# Stage 1: Build Stage
FROM node:16-alpine3.16 AS build

# Set the working directory
WORKDIR /backend

# Copy package.json and package-lock.json to the container
COPY package*.json ./

# Install all dependencies (both dev and production)
RUN npm install && \
    npm cache clean --force && \
    rm -rf /tmp/*

# Copy the rest of the application code
COPY . .

# Stage 2: Production Stage
FROM node:16-alpine3.16

# Set the working directory
WORKDIR /backend

# Copy only the necessary production files from the build stage
COPY --from=build /backend /backend

# Prune the node_modules directory to remove development dependencies
RUN npm prune --production && \
    npm cache clean --force && \
    rm -rf /tmp/*

# Set environment variables
ENV NODE_ENV=production

# Expose the port used by the app
EXPOSE 5000

# Start the application
CMD ["npm", "start"]
